---
phase: 06-regenerate-genesis-payloads-with-updated-multi-sig-governance-new-modules-and-2026-02-24t19-00-00z-genesis-time
plan: "02"
subsystem: infra
tags: [pact5, genesis, ea-tool, bootstrap-keysets, haskell, chainweb]

# Dependency graph
requires:
  - phase: 06-plan-01
    provides: "5-transaction genesis pact/yaml/json files staged for ea tool"
provides:
  - "Updated Stoa genesis records in Genesis.hs using 5-element _coinContract lists"
  - "Bootstrap keyset strategy for unsigned Pact 5 genesis execution"
  - "stoa-genesis-5.pact/json with all keyset rotations to real values"
  - "Regenerated Stoa0Payload.hs and Stoa1to9Payload.hs via ea tool"
  - "Full cabal build passing with zero warnings"
affects: [node-boot, pact-execution, genesis-blocks]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Bootstrap keyset pattern: {keys:[], pred:keys-all} always passes unsigned in Pact 5"
    - "Final rotation pattern: rotate all bootstrap keysets to real values at end of last genesis tx"
    - "namespace '' call resets Pact 5 namespace context to root"

key-files:
  created:
    - pact/genesis/stoa/stoa-genesis-5.json
  modified:
    - cwtools/ea/Ea/Genesis.hs
    - pact/genesis/stoa/stoa-genesis-1.json
    - pact/genesis/stoa/stoa-genesis-1.pact
    - pact/genesis/stoa/stoa-genesis-2.json
    - pact/genesis/stoa/stoa-genesis-5.pact
    - pact/genesis/stoa/stoa-genesis-5.yaml
    - src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs
    - src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs

key-decisions:
  - "Pact 5 genesis uses stricter enforcement than Pact 4 — FlagDisablePact44 does not apply"
  - "Bootstrap keyset pattern uses keys-all (not =) since Pact 5 readPredicate does not recognize ="
  - "All keysets that govern namespace install or module/function execution must be bootstrap throughout genesis"
  - "Keyset rotation from bootstrap to real keys works because isKeysetInSigs with empty KeysAll passes"
  - "All final rotations consolidated at end of tx5 (stoa-genesis-5.pact) for clean architecture"
  - "namespace '' call in Pact 5 resets namespace context to root for root keyset rotations"

requirements-completed: []

# Metrics
duration: 90min
completed: 2026-02-23
---

# Phase 6 Plan 02: Ea Tool Run and Genesis Payload Regeneration Summary

**Bootstrap-keyset strategy for unsigned Pact 5 genesis: all governance keysets start empty (keys-all), rotate to real keys at end of tx5 via stoa-genesis-5.pact**

## Performance

- **Duration:** ~90 min
- **Started:** 2026-02-23T01:00:00Z
- **Completed:** 2026-02-23T03:05:00Z
- **Tasks:** 2 (+ 1 Task 1 from prior session)
- **Files modified:** 8

## Accomplishments

- Updated `cwtools/ea/Ea/Genesis.hs` stoa0/stoaN records to use 5-element `_coinContract` lists
- Diagnosed root cause of ea tool failures: Stoa uses Pact 5 genesis path (not Pact 4), which enforces namespace user guards and requires bootstrap keysets for all governance keysets
- Designed and implemented bootstrap keyset strategy: all keysets that are enforced during genesis execution initialized with `{keys:[], pred:"keys-all"}` (always passes unsigned), then rotated to real values at end of tx5
- Created `stoa-genesis-5.json` with all real keyset values and updated `stoa-genesis-5.pact` to perform all rotations after xchain module deployment
- Ran ea tool successfully — `Stoa0Payload.hs` and `Stoa1to9Payload.hs` regenerated
- `cabal build chainweb-node` passes with zero warnings

## Task Commits

1. **Task 1: Update Genesis Records** - `bbc3072` (feat)
2. **Task 2: Bootstrap keysets + run Ea + rebuild** - `14d1351` (feat)

## Files Created/Modified

- `cwtools/ea/Ea/Genesis.hs` - stoa0/stoaN Genesis records updated to 5-element _coinContract lists
- `pact/genesis/stoa/stoa-genesis-1.json` - all keysets bootstrap (keys-all + empty keys array)
- `pact/genesis/stoa/stoa-genesis-1.pact` - all keyset definitions bootstrap, rotation at end removed
- `pact/genesis/stoa/stoa-genesis-2.json` - all stoa_master keysets bootstrap
- `pact/genesis/stoa/stoa-genesis-5.json` - new file with all real keyset values for final rotation
- `pact/genesis/stoa/stoa-genesis-5.pact` - adds all keyset rotations at end of genesis execution
- `pact/genesis/stoa/stoa-genesis-5.yaml` - added dataFile reference
- `src/Chainweb/BlockHeader/Genesis/Stoa0Payload.hs` - regenerated by ea (~147KB, 5 txs)
- `src/Chainweb/BlockHeader/Genesis/Stoa1to9Payload.hs` - regenerated by ea (~146KB, 5 txs)

## Decisions Made

- **Pact 5 genesis path**: Stoa's `_versionForks = AllChains ForkAtGenesis` activates Pact5Fork from block 0, so `runGenesisPayload` (not `applyGenesisCmd`) runs genesis transactions. This means `FlagDisablePact44` is NOT set, so namespace user guards ARE enforced on module deployment.
- **Bootstrap keyset pattern**: `{keys:[], pred:"keys-all"}` with empty keys always passes `isKeysetInSigs` because `KeysAll` with `count=0` checks `(0 >= 0) = true`. Using `pred:"="` would fail in Pact 5 since `readPredicate` does not recognize `"="` as a known predicate.
- **Keysets that needed bootstrap**: `ns-admin-keyset`, `ns-operate-keyset`, `util-ns-admin`, `util-ns-users` (root namespace), and all 7 `stoa-ns.stoa_master_*` keysets.
- **Final rotation in tx5**: All rotations consolidated at end of `stoa-genesis-5.pact` using `(namespace "")` to reset to root for root keysets, then `(namespace "stoa-ns")` for stoa_master keysets. Bootstrap keyset rotation succeeds because `isKeysetInSigs` with empty `KeysAll` passes.
- **`(namespace "")` valid**: Confirmed in Pact 5 source — `coreNamespace` with empty string sets `loNamespace = Nothing` (root context).
- **Module governance on initial deploy**: `evalModuleGovernance` in Compile.hs only enforces governance when upgrading (module exists). For initial deployment it calls `enforceNamespaceInstall` which checks namespace user guard (bootstrap → passes). So `KeyGov "stoa-ns.stoa_master_one"` on `stoic-predicates` is NOT enforced on first deploy.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Bootstrap keyset strategy for all genesis keysets**
- **Found during:** Task 2 (Run Ea tool)
- **Issue:** ea tool failed with `KeysetPredicateFailure` — multiple keysets needed by genesis execution were set to real keys but genesis runs with no signers in Pact 5
- **Root cause**: Stoa uses Pact 5 genesis path (`runGenesisPayload`), which enforces namespace user guards during module deployment. `FlagDisablePact44` not set (unlike Pact 4 path).
- **Fix:** Changed all governance keysets to bootstrap pattern; created stoa-genesis-5.json; updated stoa-genesis-5.pact to rotate all keysets to real values at end
- **Files modified:** stoa-genesis-1.json, stoa-genesis-1.pact, stoa-genesis-2.json, stoa-genesis-5.json (new), stoa-genesis-5.pact, stoa-genesis-5.yaml
- **Verification:** ea tool ran successfully, `cabal build chainweb-node` passes
- **Committed in:** `14d1351`

---

**Total deviations:** 1 auto-fixed (Rule 1 - bug in genesis execution approach)
**Impact on plan:** Fix was required for correctness — genesis would fail at node boot without it.

## Issues Encountered

- **Pact 5 vs Pact 4 genesis path discovery**: Pact 5's `enforceNamespaceInstall` enforces namespace user guard on module deployment (unlike Pact 4 which sets `FlagDisablePact44`). Required deep source analysis of both execution paths.
- **`pred:"="` not valid in Pact 5**: `readPredicate` only recognizes `"keys-all"`, `"keys-any"`, `"keys-2"`, and user-defined predicates. The `"="` alias used in Pact 4 is not recognized.
- **Concurrent ea truncation**: ea runs concurrent payload generation; a crashing Stoa execution truncated other payload .hs files. Fixed by restoring from Phase 3 commit before each run.

## Next Phase Readiness

- Phase 6 is complete: all genesis payloads regenerated with 5-transaction architecture
- chainweb-node builds with zero warnings with new Stoa0/Stoa1to9 payloads
- Node is ready for further testing/deployment with updated genesis

---
*Phase: 06-regenerate-genesis-payloads*
*Completed: 2026-02-23*
