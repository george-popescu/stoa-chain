---
phase: 01-contract-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pact/stoa-coin/stoa-coin.repl
autonomous: false
user_setup:
  - service: pact-repl
    why: "Pact REPL binary is required to execute .repl test files"
    env_vars: []
    dashboard_config:
      - task: "Install pact binary into PATH"
        location: "Try: cabal build pact && cabal list-bin pact, or brew install kadena-io/pact/pact, or download from https://github.com/kadena-io/pact/releases"

must_haves:
  truths:
    - "Pact REPL binary is available and can execute .repl files"
    - "All 4 bundled interfaces (fungible-v2, fungible-xchain-v1, gas-payer-v1, StoaFungibleV1) plus the coin module deploy in a single transaction without errors"
    - "All 6 tables (coin-table, LocalSupply, UR|StoaTable, UR|LocalSupply, URV|UrStoaVault, URV|UrStoaVaultUser) are created successfully"
    - "The module is named 'coin' and exposes COINBASE, GAS, GENESIS, REMEDIATE capabilities"
    - "The UC_YearZeroBlocks bug (month 21 instead of 12) is identified and either confirmed as a bug or explained"
  artifacts:
    - path: "pact/stoa-coin/stoa-coin.repl"
      provides: "STOA contract deployment and basic verification test file"
      contains: "new-coin.pact"
  key_links:
    - from: "pact/stoa-coin/stoa-coin.repl"
      to: "new-coin.pact"
      via: "(load) directive"
      pattern: "load.*new-coin"
---

<objective>
Install the Pact REPL and create a comprehensive test file that deploys the STOA coin contract with all bundled interfaces, verifies table creation, confirms the module is named "coin" with correct magic capabilities, and investigates the UC_YearZeroBlocks date format bug.

Purpose: The STOA coin contract must be proven loadable and structurally correct before any runtime touchpoint testing can proceed. This plan resolves the Pact REPL installation blocker and establishes the test harness.

Output: A working `pact/stoa-coin/stoa-coin.repl` test file that deploys the full STOA contract.
</objective>

<execution_context>
@/Users/codera/.claude/get-shit-done/workflows/execute-plan.md
@/Users/codera/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-contract-verification/01-RESEARCH.md

# Key reference files
@/Users/codera/Development/Stoa/new-coin.pact
@/Users/codera/Development/Stoa/stoa-chain/pact/coin-contract/v5/coin-v5.repl
@/Users/codera/Development/Stoa/stoa-chain/pact/coin-contract/coin.repl
</context>

<tasks>

<task type="checkpoint:human-action">
  <name>Task 1: Install Pact REPL binary</name>
  <action>
    The Pact REPL (`pact`) is NOT currently installed on this system. It must be available in PATH to execute .repl test files.

    Try these approaches in order:

    1. **Build from project dependency** (preferred):
       ```bash
       cd /Users/codera/Development/Stoa/stoa-chain
       cabal build pact
       cabal list-bin pact
       ```
       If this produces a binary, add it to PATH or symlink it.

    2. **Homebrew** (macOS):
       ```bash
       brew install kadena-io/pact/pact
       ```

    3. **GitHub releases**:
       Download from https://github.com/kadena-io/pact/releases
       Place binary in PATH.

    Verify with: `pact --version`
  </action>
  <verify>Run `which pact` and `pact --version` — both should succeed</verify>
  <done>Pact REPL binary is installed and available in PATH, confirmed by `pact --version` producing version output</done>
</task>

<task type="auto">
  <name>Task 2: Create STOA contract deployment and verification REPL test</name>
  <files>pact/stoa-coin/stoa-coin.repl</files>
  <action>
    Create a new `.repl` test file at `pact/stoa-coin/stoa-coin.repl` that:

    1. **Configures gas model** — Follow existing pattern from `pact/coin-contract/v5/coin-v5.repl`:
       ```pact
       (env-gasmodel "table")
       (env-gaslimit 300000)
       ```
       Use 300000 gas limit (higher than the default 150000) because the STOA contract is larger than Kadena's coin-v5 (1741 lines vs ~800) and bundles 4 interfaces. If 300000 is insufficient, increase further.

    2. **Define governance keysets** — Before loading the contract, the 7 Stoa Master keysets must exist because GOVERNANCE uses `keyset-ref-guard`:
       ```pact
       (begin-tx "Define governance keysets")
       (env-data {
         "stoa-ns.stoa_master_one": ["master-key-1"],
         "stoa-ns.stoa_master_two": ["master-key-2"],
         "stoa-ns.stoa_master_three": ["master-key-3"],
         "stoa-ns.stoa_master_four": ["master-key-4"],
         "stoa-ns.stoa_master_five": ["master-key-5"],
         "stoa-ns.stoa_master_six": ["master-key-6"],
         "stoa-ns.stoa_master_seven": ["master-key-7"]
       })
       (define-keyset "stoa-ns.stoa_master_one" (read-keyset "stoa-ns.stoa_master_one"))
       ;; ... repeat for all seven ...
       (commit-tx)
       ```

    3. **Load the STOA contract** — The contract file (`new-coin.pact`) bundles all interfaces inline and has `create-table` statements at the bottom. Copy it into `pact/stoa-coin/` first, then load:
       ```pact
       (begin-tx "Deploy STOA coin contract")
       (load "new-coin.pact")
       (commit-tx)
       ```
       IMPORTANT: Copy `/Users/codera/Development/Stoa/new-coin.pact` to `pact/stoa-coin/new-coin.pact` so the `.repl` file can reference it with a relative path.

    4. **Verify module deployment** — After loading:
       ```pact
       (begin-tx "Verify contract deployment")
       (use coin)
       ;; Verify module name is "coin"
       (expect "precision returns 12" 12 (precision))
       ;; Verify VALID_CHAIN_IDS has 10 entries
       (expect "10 valid chain IDs" 10 (length VALID_CHAIN_IDS))
       ;; Verify magic capabilities can be tested
       (test-capability (COINBASE))
       (test-capability (GAS))
       (test-capability (GENESIS))
       (test-capability (REMEDIATE))
       (commit-tx)
       ```

    5. **Test UC_YearZeroBlocks** — Research identified line 396 has `"{}-21-31"` which looks like month 21 (should be 12 for December):
       ```pact
       (begin-tx "Test UC_YearZeroBlocks for date bug")
       (use coin)
       (env-chain-data {"block-time": (time "2026-06-15T12:00:00Z")})
       ;; UC_YearZeroBlocks tries to parse "{year}-21-31 23:59:59"
       ;; If this fails, it confirms the month typo bug
       ;; If it succeeds, check the value is sensible (should be ~28800 blocks for 10 chains * ~300 days remaining in 2026)
       (let ((blocks (UC_YearZeroBlocks)))
         (expect "Year zero blocks is positive" true (> blocks 0))
         (expect "Year zero blocks is reasonable (between 1000 and 100000000)"
           true
           (and (> blocks 1000) (< blocks 100000000)))
       )
       (commit-tx)
       ```

    6. **Test basic account operations** — Create accounts and verify basic read/write:
       ```pact
       (begin-tx "Test basic account operations")
       (use coin)
       (env-data {"test-account": ["test-key-1"]})
       (env-keys ["test-key-1"])
       (create-account "test-account" (read-keyset "test-account"))
       (expect "new account has 0 balance" 0.0 (get-balance "test-account"))
       (expect "details returns correct structure"
         {"account": "test-account", "balance": 0.0, "guard": (read-keyset "test-account")}
         (details "test-account"))
       (commit-tx)
       ```

    Run the test file: `pact pact/stoa-coin/stoa-coin.repl`

    If the contract fails to load due to gas limits, increase `env-gaslimit`. If it fails due to keyset issues (the `stoa-ns` prefix), try defining keysets without the namespace prefix and adjust accordingly -- but DO NOT modify the contract itself in this phase; only adjust the test environment.
  </action>
  <verify>
    Run `pact pact/stoa-coin/stoa-coin.repl` from the stoa-chain directory. All expect assertions must pass. The contract must deploy without errors. If UC_YearZeroBlocks fails, document the exact error.
  </verify>
  <done>
    1. The file `pact/stoa-coin/stoa-coin.repl` exists and runs to completion
    2. All 4 interfaces and the coin module deploy in one load operation
    3. All 6 tables are created (coin-table, LocalSupply, UR|StoaTable, UR|LocalSupply, URV|UrStoaVault, URV|UrStoaVaultUser)
    4. Module is named "coin", exposes COINBASE/GAS/GENESIS/REMEDIATE capabilities
    5. UC_YearZeroBlocks behavior is documented (either works or the month typo is confirmed)
    6. Basic account creation and balance queries work
  </done>
</task>

</tasks>

<verification>
1. `which pact` returns a valid path
2. `pact pact/stoa-coin/stoa-coin.repl` runs to completion with all assertions passing
3. The STOA contract loads without compilation or interface mismatch errors
4. UC_YearZeroBlocks bug status is known (either confirmed or ruled out)
</verification>

<success_criteria>
- Pact REPL is installed and functional
- STOA coin contract deploys successfully with all bundled interfaces
- Module named "coin" with all 4 magic capabilities verified
- All 6 tables created
- UC_YearZeroBlocks date parsing bug status documented
- Basic account operations (create, get-balance, details) work
</success_criteria>

<output>
After completion, create `.planning/phases/01-contract-verification/01-01-SUMMARY.md`
</output>
