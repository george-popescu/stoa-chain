---
phase: 02-version-definition-and-gas-limits
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Chainweb/Version/Stoa.hs
autonomous: true

must_haves:
  truths:
    - "A Stoa version definition exists with ChainwebVersionCode 0x0000_000A and name 'stoa'"
    - "The version uses petersenChainGraph (10 chains, degree 3, diameter 2)"
    - "All Fork constructors are covered via wildcard pattern, all set to ForkAtGenesis"
    - "_versionMaxBlockGasLimit is set to Just 500,000"
    - "Genesis payload ChainMap references only chains 0-9"
    - "Pattern synonym 'Stoa' is exported for pattern matching"
  artifacts:
    - path: "src/Chainweb/Version/Stoa.hs"
      provides: "Stoa version definition module"
      exports: ["stoa", "pattern Stoa"]
      contains: "petersenChainGraph"
  key_links:
    - from: "src/Chainweb/Version/Stoa.hs"
      to: "src/Chainweb/Graph.hs"
      via: "import of petersenChainGraph"
      pattern: "petersenChainGraph"
    - from: "src/Chainweb/Version/Stoa.hs"
      to: "src/Chainweb/BlockHeader/Genesis/Development0Payload.hs"
      via: "temporary genesis payload import"
      pattern: "Development0Payload"
---

<objective>
Create the Stoa version definition module (src/Chainweb/Version/Stoa.hs) with all version properties: unique version code, Petersen graph topology, all forks at genesis, 500k max gas limit, and temporary devnet genesis payloads.

Purpose: This is the core artifact for Phase 2 -- the ChainwebVersion record that defines the Stoa blockchain's topology, fork schedule, gas limits, and genesis configuration. Every other Phase 2 task depends on this module existing.

Output: src/Chainweb/Version/Stoa.hs -- a complete, compilable (once registered in cabal) Haskell module exporting `stoa` and pattern `Stoa`.
</objective>

<execution_context>
@/Users/codera/.claude/get-shit-done/workflows/execute-plan.md
@/Users/codera/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-version-definition-and-gas-limits/02-RESEARCH.md
@src/Chainweb/Version/Development.hs
@src/Chainweb/Version.hs
@src/Chainweb/Graph.hs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/Chainweb/Version/Stoa.hs with complete version definition</name>
  <files>src/Chainweb/Version/Stoa.hs</files>
  <action>
Create a new file `src/Chainweb/Version/Stoa.hs` modeled on `src/Chainweb/Version/Development.hs` with these specific differences:

**Module declaration:**
```haskell
module Chainweb.Version.Stoa(stoa, pattern Stoa) where
```

**Pattern synonym:**
```haskell
pattern Stoa :: ChainwebVersion
pattern Stoa <- ((== stoa) -> True) where
    Stoa = stoa
```

**Version record -- exact field values (differences from devnet highlighted):**

| Field | Value | Notes |
|-------|-------|-------|
| `_versionCode` | `ChainwebVersionCode 0x0000_000A` | Unique; existing: 0x01, 0x02, 0x05, 0x07; test codes start at 0x80000000 |
| `_versionName` | `ChainwebVersionName "stoa"` | CLI: `--chainweb-version stoa` |
| `_versionForks` | `tabulateHashMap $ \case _ -> AllChains ForkAtGenesis` | Wildcard covers all 37 Fork constructors |
| `_versionUpgrades` | `AllChains mempty` | Same as devnet |
| `_versionGraphs` | `Bottom (minBound, petersenChainGraph)` | NOT twentyChainGraph -- this is the key topology change |
| `_versionBlockDelay` | `BlockDelay 30_000_000` | 30 seconds, same as devnet |
| `_versionWindow` | `WindowWidth 120` | Same as devnet |
| `_versionHeaderBaseSizeBytes` | `318 - 110` | Same as devnet; Petersen has degree 3, same as Twenty |
| `_versionMaxBlockGasLimit` | `Bottom (minBound, Just 500_000)` | GAS-01: hard cap at 500k. Devnet has `Nothing` (no limit) |
| `_versionMinimumBlockHeaderHistory` | `Bottom (minBound, Nothing)` | Same as devnet |
| `_versionBootstraps` | `[]` | No bootstrap nodes yet |
| `_versionGenesis` | See below | Chains 0-9 ONLY |
| `_versionCheats` | `_disablePow = True, _fakeFirstEpochStart = True, _disablePact = False` | Phase 2: PoW disabled for testing. Phase 5 enables it. |
| `_versionDefaults` | `_disablePeerValidation = True, _disableMempoolSync = False` | Same as devnet |
| `_versionVerifierPluginNames` | `AllChains $ Bottom (minBound, Set.fromList $ map VerifierName ["hyperlane_v3_message", "allow", "signed_list"])` | Same as devnet |
| `_versionQuirks` | `noQuirks` | Same as devnet |
| `_versionForkNumber` | `0` | Same as devnet |

**Genesis data (CRITICAL -- chains 0-9 only):**
```haskell
_versionGenesis = VersionGenesis
    { _genesisBlockTarget = AllChains $ HashTarget (maxBound `div` 100_000)
    , _genesisTime = AllChains $ BlockCreationTime [timeMicrosQQ| 2026-03-01T00:00:00.000000 |]
    , _genesisBlockPayload = onChains $ concat
        [ [(unsafeChainId 0, DN0.payloadBlock)]
        , [(unsafeChainId i, DNN.payloadBlock) | i <- [1..9]]
        ]
    }
```

IMPORTANT: The genesis payload list ends at chain 9, NOT 19. Using devnet payloads (DN0, DNN) as temporaries until Phase 3 generates Stoa-specific ones.

**Imports -- copy from Development.hs exactly, including:**
```haskell
import qualified Data.Set as Set
import Chainweb.BlockCreationTime
import Chainweb.ChainId
import Chainweb.Difficulty
import Chainweb.Graph
import Chainweb.Time
import Chainweb.Utils
import Chainweb.Utils.Rule
import Chainweb.Version
import Pact.Types.Verifier
import qualified Chainweb.BlockHeader.Genesis.Development0Payload as DN0
import qualified Chainweb.BlockHeader.Genesis.Development1to19Payload as DNN
```

**Language extensions -- same as Development.hs:**
```haskell
{-# LANGUAGE LambdaCase #-}
{-# LANGUAGE NumericUnderscores #-}
{-# LANGUAGE OverloadedStrings #-}
{-# LANGUAGE PatternSynonyms #-}
{-# LANGUAGE QuasiQuotes #-}
{-# LANGUAGE ViewPatterns #-}
```

Add a comment at the top: `-- | Stoa chain version definition. Uses devnet genesis payloads temporarily (Phase 3 generates real ones).`
  </action>
  <verify>
Verify the file exists and contains the critical values:
- `grep "petersenChainGraph" src/Chainweb/Version/Stoa.hs` returns a match
- `grep "0x0000_000A" src/Chainweb/Version/Stoa.hs` returns a match
- `grep "Just 500_000" src/Chainweb/Version/Stoa.hs` returns a match
- `grep '\[1\.\.9\]' src/Chainweb/Version/Stoa.hs` returns a match (chains 1-9, not 1-19)
- `grep "stoa" src/Chainweb/Version/Stoa.hs` returns matches for version name
  </verify>
  <done>
src/Chainweb/Version/Stoa.hs exists with:
- ChainwebVersionCode 0x0000_000A
- ChainwebVersionName "stoa"
- petersenChainGraph (not twentyChainGraph)
- All forks at genesis via wildcard pattern
- _versionMaxBlockGasLimit = Bottom (minBound, Just 500_000)
- Genesis payloads for chains 0-9 only (using devnet temporaries)
- Pattern synonym Stoa exported
  </done>
</task>

</tasks>

<verification>
- File exists at src/Chainweb/Version/Stoa.hs
- Module declaration exports `stoa` and `pattern Stoa`
- No reference to `twentyChainGraph` (must use `petersenChainGraph`)
- No chain IDs above 9 in genesis payload list
- `_versionMaxBlockGasLimit` uses `Just 500_000` not `Nothing`
- `_disablePow = True` (Phase 2 only; Phase 5 will change this)
</verification>

<success_criteria>
A complete Stoa.hs file exists that would pass `validateVersion` once registered (all forks covered, genesis data for all 10 chains, valid gas limit Rule). The file follows the exact same structure as Development.hs.
</success_criteria>

<output>
After completion, create `.planning/phases/02-version-definition-and-gas-limits/02-01-SUMMARY.md`
</output>
