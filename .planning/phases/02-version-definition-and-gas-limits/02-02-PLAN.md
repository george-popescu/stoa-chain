---
phase: 02-version-definition-and-gas-limits
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - chainweb.cabal
  - src/Chainweb/Version/Registry.hs
  - src/Chainweb/Chainweb/Configuration.hs
autonomous: true

must_haves:
  truths:
    - "Stoa version is registered in knownVersions and passes validateVersion at program initialization"
    - "Stoa version is selectable via --chainweb-version stoa CLI argument"
    - "_configBlockGasLimit default is 400,000 and clamping logic correctly computes min(400000, 500000) = 400,000"
    - "The project compiles with cabal build chainweb (zero warnings, zero errors under -Wall -Werror)"
  artifacts:
    - path: "chainweb.cabal"
      provides: "Stoa module registration in build system"
      contains: "Chainweb.Version.Stoa"
    - path: "src/Chainweb/Version/Registry.hs"
      provides: "Version registration and lookup"
      contains: "stoa"
    - path: "src/Chainweb/Chainweb/Configuration.hs"
      provides: "Gas limit default and version validation"
      contains: "400_000"
  key_links:
    - from: "src/Chainweb/Version/Registry.hs"
      to: "src/Chainweb/Version/Stoa.hs"
      via: "import Chainweb.Version.Stoa"
      pattern: "import Chainweb\\.Version\\.Stoa"
    - from: "src/Chainweb/Version/Registry.hs"
      to: "src/Chainweb/Version/Stoa.hs"
      via: "stoa added to knownVersions list"
      pattern: "knownVersions.*stoa"
    - from: "src/Chainweb/Chainweb/Configuration.hs"
      to: "src/Chainweb/Version/Stoa.hs"
      via: "stoa added to isDevelopment check in validateChainwebVersion"
      pattern: "stoa"
    - from: "src/Chainweb/Chainweb/Configuration.hs"
      to: "src/Chainweb/Chainweb.hs"
      via: "400k default flows into clamping logic at startup"
      pattern: "400_000"
---

<objective>
Wire the Stoa version into the build system, version registry, and configuration, then verify the entire project compiles successfully.

Purpose: The Stoa version definition from Plan 01 is inert until it is: (1) listed in the cabal build manifest, (2) registered in Registry.hs so validateVersion runs at startup, (3) added to findKnownVersion so CLI --chainweb-version stoa works, and (4) Configuration.hs is updated with the 400k gas default and version validation allowance. This plan completes all wiring and proves correctness via compilation.

Output: Modified chainweb.cabal, Registry.hs, Configuration.hs -- all compiling cleanly under -Wall -Werror.
</objective>

<execution_context>
@/Users/codera/.claude/get-shit-done/workflows/execute-plan.md
@/Users/codera/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-version-definition-and-gas-limits/02-RESEARCH.md
@.planning/phases/02-version-definition-and-gas-limits/02-01-SUMMARY.md
@src/Chainweb/Version/Registry.hs
@src/Chainweb/Chainweb/Configuration.hs
@chainweb.cabal
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Stoa module to cabal and wire into Registry.hs</name>
  <files>chainweb.cabal, src/Chainweb/Version/Registry.hs</files>
  <action>
**chainweb.cabal changes:**

Add `Chainweb.Version.Stoa` to the `exposed-modules` list in the library section. Place it after `Chainweb.Version.RecapDevelopment` (alphabetically: Development, Mainnet, RecapDevelopment, Stoa, Testnet04). The line is around line 270-275 of chainweb.cabal:

```
        , Chainweb.Version.Development
        ...
        , Chainweb.Version.RecapDevelopment
        , Chainweb.Version.Stoa
        , Chainweb.Version.Testnet04
```

**Registry.hs changes (4 specific locations):**

1. **Add import** (after the existing version imports around line 48-51):
```haskell
import Chainweb.Version.Stoa
```

2. **Add to knownVersions** (line 166):
Change from:
```haskell
knownVersions = [mainnet, testnet04, recapDevnet, devnet]
```
To:
```haskell
knownVersions = [mainnet, testnet04, recapDevnet, devnet, stoa]
```

3. **Add fast path to lookupVersionByCode** (around line 122-124):
After the testnet04 fast path, before the `| otherwise` case:
```haskell
    | code == _versionCode stoa = stoa
```

4. **Add fast path to lookupVersionByName** (around line 147-149):
After the testnet04 fast path, before the `| otherwise` case:
```haskell
    | name == _versionName stoa = stoa
```

5. **Add helpful error message for stoa** in the `notRegistered` helper of `lookupVersionByCode` (around line 137-139):
Add a case after the devnet case:
```haskell
        | code == _versionCode stoa = "stoa version used but not registered, remember to do so after it's configured. " <> perhaps
```

6. **Add helpful error message for stoa** in `lookupVersionByName` (around line 156-158):
Add a case after the devnet case:
```haskell
      | name == _versionName stoa = "stoa version used but not registered, remember to do so after it's configured"
```

7. **Update findKnownVersion error message** (line 173):
Change the error text to include stoa:
```haskell
        Nothing -> fail $ T.unpack (getChainwebVersionName vn) <> " is not a known version: try stoa, development, mainnet01, or testnet04"
```

IMPORTANT: `versionMap` initializer (line 59) only contains mainnet and testnet04 -- do NOT add stoa there. The version gets registered dynamically via `registerVersion` call in ChainwebNode.hs main when the user selects `--chainweb-version stoa`. The `knownVersions` list is what `validateVersion` iterates at initialization time (line 58).
  </action>
  <verify>
- `grep "Chainweb.Version.Stoa" chainweb.cabal` returns a match
- `grep "import Chainweb.Version.Stoa" src/Chainweb/Version/Registry.hs` returns a match
- `grep "stoa" src/Chainweb/Version/Registry.hs` returns matches in knownVersions, lookupVersionByCode, lookupVersionByName, findKnownVersion
  </verify>
  <done>
Stoa module is in chainweb.cabal exposed-modules. Registry.hs imports Stoa, includes it in knownVersions, and has fast-path lookups by code and name.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Configuration.hs gas default and version validation, then compile</name>
  <files>src/Chainweb/Chainweb/Configuration.hs</files>
  <action>
**Configuration.hs changes:**

1. **Add import** (after the existing version imports around line 119-122):
```haskell
import Chainweb.Version.Stoa
```

2. **Change _configBlockGasLimit default** (line 455):
Change from:
```haskell
    , _configBlockGasLimit = 150_000
```
To:
```haskell
    , _configBlockGasLimit = 400_000
```
This is GAS-02. The change is global but SAFE because the clamping logic in Chainweb.hs (line 442: `maybe id min maxGasLimit (_configBlockGasLimit conf)`) ensures that versions with lower max limits are protected. For example, mainnet's max is 180k, so min(400k, 180k) = 180k.

3. **Add stoa to validateChainwebVersion isDevelopment check** (line 435):
Change from:
```haskell
    isDevelopment = _versionCode v `elem` [_versionCode dv | dv <- [recapDevnet, devnet]]
```
To:
```haskell
    isDevelopment = _versionCode v `elem` [_versionCode dv | dv <- [recapDevnet, devnet, stoa]]
```
This allows Stoa version properties to be customized at the CLI level (e.g., --disable-pow, --block-delay, --fork-upper-bound flags).

**Compile the project:**

After all changes, run:
```bash
cd /Users/codera/Development/Stoa/stoa-chain && cabal build chainweb 2>&1
```

This compiles under `-Wall -Werror -Wcompat`. If it passes, ALL of the following are proven:
- Stoa.hs is syntactically and type-correct
- All imports resolve (petersenChainGraph, DN0, DNN, etc.)
- Registry.hs compiles with the new import and all pattern matches
- Configuration.hs compiles with the new gas limit and validation change
- `validateVersion` passes for stoa at IORef initialization time (line 58 of Registry.hs: `traverse_ validateVersion knownVersions`)

If compilation fails, diagnose the error and fix. Common issues:
- Missing import in Stoa.hs (e.g., forgot `Chainweb.ChainId` for `unsafeChainId`)
- Redundant import warning (if an import is unused, remove it)
- Non-exhaustive pattern (should not happen with wildcard `_ ->`)
  </action>
  <verify>
- `cabal build chainweb` exits with code 0 (no warnings, no errors)
- `grep "400_000" src/Chainweb/Chainweb/Configuration.hs` confirms GAS-02 default
- `grep "stoa" src/Chainweb/Chainweb/Configuration.hs` confirms version validation inclusion
  </verify>
  <done>
Configuration.hs has _configBlockGasLimit = 400,000, stoa is in the isDevelopment check, and `cabal build chainweb` compiles successfully with zero warnings under -Wall -Werror. This proves:
- VERS-01: Version code 0x0000_000A exists
- VERS-02: petersenChainGraph is used
- VERS-03: All forks at genesis (validateVersion would fail otherwise)
- VERS-04: Only chains 0-9 in ChainMaps (validateVersion checks this)
- VERS-05: Registered in knownVersions, passes validateVersion
- VERS-06: CLI --chainweb-version stoa works (findKnownVersion resolves it)
- GAS-01: _versionMaxBlockGasLimit = Just 500,000
- GAS-02: _configBlockGasLimit = 400,000
- GAS-03: No changes needed; existing clamping computes min(400k, 500k) = 400k correctly
  </done>
</task>

</tasks>

<verification>
1. `cabal build chainweb` exits 0 -- this is the single most important check, as it proves type correctness, import resolution, and that validateVersion passes for stoa at initialization
2. `grep -c "stoa" src/Chainweb/Version/Registry.hs` returns >= 5 (import, knownVersions, lookupByCode, lookupByName, error messages)
3. `grep "400_000" src/Chainweb/Chainweb/Configuration.hs` returns a match for the gas limit default
4. No reference to chain IDs > 9 in src/Chainweb/Version/Stoa.hs
</verification>

<success_criteria>
The Stoa version is fully wired into the system: registered in the build manifest, discoverable by the version registry, selectable via CLI, with correct gas limit defaults. The project compiles cleanly, proving all 9 requirements (VERS-01 through VERS-06, GAS-01 through GAS-03) are met.
</success_criteria>

<output>
After completion, create `.planning/phases/02-version-definition-and-gas-limits/02-02-SUMMARY.md`
</output>
